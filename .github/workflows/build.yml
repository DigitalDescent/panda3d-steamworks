# ──────────────────────────────────────────────────────────────────────────────
# CI / CD – Build Panda3D from source (cached), compile steamworks wheels,
# and publish to PyPI on tagged releases.
#
# Inspired by the panda3d CI workflow.  Each (os × python-version) job
# builds a minimal Panda3D SDK from source, caches it, then compiles the
# panda3d-steamworks wheel against that SDK.
# ──────────────────────────────────────────────────────────────────────────────
name: Build and Publish

on:
  push:
    branches: [master, main]
    tags: ["v*"]
  pull_request:
    branches: [master, main]
  workflow_dispatch:
    inputs:
      panda3d_ref:
        description: "Panda3D git ref (branch / tag / SHA)"
        default: "release/1.10.x"
        type: string

env:
  # Panda3D source to build against.  Override via workflow_dispatch input.
  PANDA3D_REF: ${{ inputs.panda3d_ref || 'release/1.10.x' }}
  # Panda3D thirdparty tools version (for Windows & macOS native deps).
  P3D_TOOLS_VER: "1.10.16"

permissions:
  contents: write

# ══════════════════════════════════════════════════════════════════════════════
jobs:
  # ────────────────────────────────────────────────────────────────────────────
  # Build wheels  –  one job per (platform × Python version)
  # ────────────────────────────────────────────────────────────────────────────
  build:
    name: "${{ matrix.os }} / py${{ matrix.python-version }}"
    if: >-
      !contains(github.event.head_commit.message, '[skip ci]') &&
      !contains(github.event.head_commit.message, '[ci skip]')

    strategy:
      fail-fast: false
      matrix:
        os: [windows-2022, ubuntu-24.04, macOS-15]
        python-version: ["3.10", "3.11", "3.12", "3.13"]

    runs-on: ${{ matrix.os }}

    steps:
    # ── 1. Checkout steamworks repo (with Steamworks SDK submodule) ────────
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    # ── 2. Python ──────────────────────────────────────────────────────────
    - name: Setup Python ${{ matrix.python-version }}
      uses: actions/setup-python@v6
      with:
        python-version: ${{ matrix.python-version }}

    # ── 3. Platform build tools (always needed — we compile C++ either way) ─
    - name: Install build tools (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential cmake bison flex \
          libeigen3-dev libfreetype6-dev libjpeg-dev libpng-dev \
          libssl-dev libvorbis-dev zlib1g-dev \
          libgl1-mesa-dev libegl1-mesa-dev libx11-dev libxrandr-dev

    - name: Install build tools (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install cmake eigen
        sudo xcode-select -s /Applications/Xcode_16.app/Contents/Developer

    # ── 4. Caches ──────────────────────────────────────────────────────────
    #   • Panda3D build  → per (os, python-version, ref)
    #   • Panda3D thirdparty (Windows) → shared across Python versions
    - name: Cache Panda3D build
      id: cache-panda3d
      uses: actions/cache@v5
      with:
        path: panda3d-src/built
        key: panda3d-built-${{ runner.os }}-py${{ matrix.python-version }}-${{ env.PANDA3D_REF }}-v1

    - name: Cache Panda3D thirdparty (Windows)
      if: runner.os == 'Windows'
      id: cache-thirdparty-win
      uses: actions/cache@v5
      with:
        path: panda3d-src/thirdparty
        key: panda3d-thirdparty-windows-${{ env.P3D_TOOLS_VER }}-v1

    # ── 5. Clone Panda3D source (only when build not cached) ───────────────
    - name: Clone Panda3D
      if: steps.cache-panda3d.outputs.cache-hit != 'true'
      uses: actions/checkout@v4
      with:
        repository: panda3d/panda3d
        ref: ${{ env.PANDA3D_REF }}
        path: panda3d-src
        fetch-depth: 1

    # ── 6. Platform thirdparty downloads ───────────────────────────────────
    - name: Download Panda3D thirdparty (Windows)
      if: >-
        runner.os == 'Windows' &&
        steps.cache-thirdparty-win.outputs.cache-hit != 'true'
      shell: powershell
      run: |
        if (!(Test-Path "panda3d-src\thirdparty\win-libs-vc14-x64")) {
          $ProgressPreference = 'SilentlyContinue'
          Invoke-WebRequest `
            -Uri "https://www.panda3d.org/download/panda3d-${{ env.P3D_TOOLS_VER }}/panda3d-${{ env.P3D_TOOLS_VER }}-tools-win64.zip" `
            -OutFile thirdparty.zip
          Expand-Archive -Path thirdparty.zip -DestinationPath thirdparty-extract
          New-Item -ItemType Directory -Force -Path panda3d-src | Out-Null
          if (Test-Path "panda3d-src\thirdparty") {
            Remove-Item -Recurse -Force "panda3d-src\thirdparty"
          }
          Move-Item "thirdparty-extract\panda3d-${{ env.P3D_TOOLS_VER }}\thirdparty" "panda3d-src\"
        }

    - name: Download Panda3D thirdparty (macOS)
      if: >-
        runner.os == 'macOS' &&
        steps.cache-panda3d.outputs.cache-hit != 'true'
      run: |
        curl -sLO "https://www.panda3d.org/download/panda3d-${{ env.P3D_TOOLS_VER }}/panda3d-${{ env.P3D_TOOLS_VER }}-tools-mac.tar.gz"
        tar -xf "panda3d-${{ env.P3D_TOOLS_VER }}-tools-mac.tar.gz"
        mv "panda3d-${{ env.P3D_TOOLS_VER }}/thirdparty" panda3d-src/thirdparty
        # Fix Cg dylib id so pzip can run during the build.
        install_name_tool -id \
          "$(pwd)/panda3d-src/thirdparty/darwin-libs-a/nvidiacg/lib/libCg.dylib" \
          panda3d-src/thirdparty/darwin-libs-a/nvidiacg/lib/libCg.dylib 2>/dev/null || true

    # ── 7. Build Panda3D from source ───────────────────────────────────────
    - name: Build Panda3D
      if: steps.cache-panda3d.outputs.cache-hit != 'true'
      shell: bash
      run: |
        cd panda3d-src
        python makepanda/makepanda.py \
          --outputdir built \
          --everything --no-eigen \
          --python-incdir="$pythonLocation/include" \
          --python-libdir="$pythonLocation/lib" \
          --verbose --threads=4 \
          ${{ runner.os == 'Windows' && '--windows-sdk=10 --msvc-version=14.3' || '' }}

    # ── 8. Prepare SDK environment for steamworks build ────────────────────
    - name: Add Panda3D to PATH
      shell: bash
      run: |
        # bin/ has interrogate + runtime DLLs (Windows)
        echo "$GITHUB_WORKSPACE/panda3d-src/built/bin" >> "$GITHUB_PATH"

    - name: Create thirdparty compatibility junctions (Windows)
      if: runner.os == 'Windows'
      shell: powershell
      run: |
        # get_win_thirdparty_dir() searches for "thirdparty/win-libs" relative
        # to the SDK path (panda3d-src/built/).  The actual thirdparty folder
        # is panda3d-src/thirdparty/win-libs-vc14-x64.
        # Create one direct junction at the exact searched path.
        $realTP = (Resolve-Path "panda3d-src\thirdparty\win-libs-vc14-x64").Path
        $builtTPDir = "panda3d-src\built\thirdparty"
        $link = "$builtTPDir\win-libs"

        # Ensure the built/thirdparty directory exists (as a real dir, not a junction)
        if (Test-Path $builtTPDir) {
          # If it's a junction from a previous run, remove it first
          $item = Get-Item $builtTPDir -Force
          if ($item.Attributes -band [IO.FileAttributes]::ReparsePoint) {
            $item.Delete()
          }
        }
        New-Item -ItemType Directory -Force -Path $builtTPDir | Out-Null

        # Create the single junction: built/thirdparty/win-libs → real thirdparty dir
        if (!(Test-Path $link)) {
          New-Item -ItemType Junction -Path $link -Target $realTP | Out-Null
        }
        Write-Host "Junction: $link -> $realTP"

    # ── 9. Build the panda3d-steamworks wheel ──────────────────────────────
    - name: Install Python build tools
      run: pip install build "setuptools>=64" wheel

    - name: Build wheel
      shell: bash
      env:
        PYTHONPATH: ${{ github.workspace }}/panda3d-src/built
        LD_LIBRARY_PATH: ${{ github.workspace }}/panda3d-src/built/lib
        DYLD_LIBRARY_PATH: ${{ github.workspace }}/panda3d-src/built/lib
      run: python -m build --wheel

    # ── 9b. Repair wheels (Linux / macOS) ──────────────────────────────────
    #   PyPI rejects bare "linux_x86_64" tags; auditwheel converts them to
    #   the appropriate manylinux tag.  delocate fixes macOS wheels similarly.
    - name: Repair wheel (Linux - auditwheel)
      if: runner.os == 'Linux'
      run: |
        pip install auditwheel patchelf
        mkdir -p dist-repaired
        # Use the glibc version from the build host (Ubuntu 24.04 → glibc 2.39)
        GLIBC_VER=$(ldd --version | head -1 | grep -oP '\d+\.\d+$')
        MANYLINUX="manylinux_${GLIBC_VER//./_}_x86_64"
        echo "Targeting platform tag: $MANYLINUX"
        auditwheel repair dist/*.whl \
          --plat "$MANYLINUX" \
          -w dist-repaired
        rm -rf dist
        mv dist-repaired dist

    # ── 10. Upload ─────────────────────────────────────────────────────────
    - name: Upload wheel artifact
      uses: actions/upload-artifact@v4
      with:
        name: wheel-${{ matrix.os }}-py${{ matrix.python-version }}
        path: dist/*.whl
        if-no-files-found: error

  # ────────────────────────────────────────────────────────────────────────────
  # Deploy documentation to GitHub Pages (main/master pushes only)
  # ────────────────────────────────────────────────────────────────────────────
  docs:
    name: Deploy docs to GitHub Pages
    runs-on: ubuntu-latest
    if: >-
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    permissions:
      pages: write
      id-token: write

    concurrency:
      group: pages
      cancel-in-progress: true

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.12"

    - name: Generate API docs
      run: python scripts/codegen_docs.py

    - name: Setup Pages
      uses: actions/configure-pages@v5

    - name: Build with Jekyll
      uses: actions/jekyll-build-pages@v1
      with:
        source: ./docs
        destination: ./_site

    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./_site

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

  # ────────────────────────────────────────────────────────────────────────────
  # Publish to PyPI (tagged releases only)
  # ────────────────────────────────────────────────────────────────────────────
  publish:
    name: Publish to PyPI
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    permissions:
      id-token: write          # required for trusted publishing

    environment:
      name: pypi
      url: https://pypi.org/p/panda3d-steamworks

    steps:
    - name: Download all wheel artifacts
      uses: actions/download-artifact@v4
      with:
        path: dist
        pattern: wheel-*
        merge-multiple: true

    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        packages-dir: dist/

  # ────────────────────────────────────────────────────────────────────────────
  # GitHub Release (tagged releases only)
  # ────────────────────────────────────────────────────────────────────────────
  github-release:
    name: GitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    permissions:
      contents: write          # required to create releases

    steps:
    - name: Download all wheel artifacts
      uses: actions/download-artifact@v4
      with:
        path: dist
        pattern: wheel-*
        merge-multiple: true

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.ref_name }}
        name: ${{ github.ref_name }}
        generate_release_notes: true
        files: dist/*.whl

